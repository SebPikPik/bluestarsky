# This is a basic workflow to help you get started with Actions

name: Post to Blue Sky

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the "master" branch
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  rsi_status_bluesky:
    permissions:
      # Give the default GITHUB_TOKEN write permission to commit and push the
      # added or changed files to the repository.
      contents: write
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - name: Fetch RSS Feed
        uses: Promptly-Technologies-LLC/rss-fetch-action@v2
        with:
          feed_url: 'https://status.robertsspaceindustries.com/index.xml'
          file_path: './feed.json'
    
      - name: Commit and push changes to repository
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'Update RSS feed'
          file_pattern: '*.json'
      
      - name: Parse entries
        run: |
          echo "POST_ID=$(cat feed.json | jq '.entries | max_by(.published)' | jq '.id')" >> $GITHUB_ENV
          echo "POST_TITLE=$(cat feed.json | jq '.entries | max_by(.published)' | jq '.title')" >> $GITHUB_ENV
          echo "POST_LINK=$(cat feed.json | jq '.entries | max_by(.published)' | jq '.link')" >> $GITHUB_ENV
          echo "POST_DATE=$(cat feed.json | jq '.entries | max_by(.published)' | jq '.published')" >> $GITHUB_ENV
          echo "POST_DESC=$(cat feed.json | jq -r '.entries | max_by(.published) | .description | @sh "sed \'s/`/\\\\\\\\\\\`/g\'" | @json')
          echo "POST_DESC content: $POST_DESC"

          
      - name: Make Gemini cook a sentence
        id: gemini
        # shell: python
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          JSON_PAYLOAD=$(jq -n \
                         --arg escaped_desc "$POST_DESC" \
                         '{contents: [{parts: [{text: "Fais une phrase en francais à propos du status : " + ($escaped_desc | @json) + ". Cette phrase doit parler de l\'etat des serveurs Star Citizen et s\'il est possible de jouer en ce moment ou non. Cette réponse ne peut pas faire plus de 200 caractères"}]}]}')
          echo "JSON_PAYLOAD: $JSON_PAYLOAD" # Debugging line
          # ... rest of your curl command ...







      # - name: Test variables
      #   run: |
      #     echo "POST_ID: $POST_ID"
      #     echo ""
      # - name: Send Bluesky Post
      #   uses: myConsciousness/bluesky-post@v5
      #   with:
      #     identifier: ${{ secrets.BLUESKY_HANDLE }} # Your handle (example: username.bsky.social)
      #     password: ${{ secrets.BLUESKY_PASSWORD }} # Your password
      #     labels: "starcitizen,rsistatus"
      #     tags: "starcitizen,rsistatus,rsi"
      #     link-preview-url: "${{ steps.rss.outputs.url }}"
      #     text: |
      #       ${{ env.GEMINI_SENTENCE }} #StarCitizen
      #       Status : ${{ env.POST_LINK }} - Date : ${{ env.POST_DATE }}
      #       [Créez votre compte StarCitizen](https://shorturl.at/ItWLR)
